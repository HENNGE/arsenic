version: 2
defaults: &defaults
  working_directory: /home/
  docker:
    - image: docker:latest
jobs:
  build:
    <<: *defaults
    steps:
      - setup_remote_docker:
          reusable: true
          exclusive: true
      - checkout
      - run:
          name: Build base image
          command: |
            docker build \
            --tag base:1.0 \
            --file tests/dockerfiles/base \
            .
      - run:
          name: Setup unit 
          command: |
            docker build \
            --tag unit \
            --file tests/dockerfiles/unit \
            .
      - run:
          name: Setup phantomjs 
          command: |
            docker build \
            --tag phantomjs \
            --file tests/dockerfiles/phantomjs \
            .
      - run:
          name: Setup geckodriver 
          command: |
            docker build \
            --tag geckodriver \
            --file tests/dockerfiles/geckodriver \
            .
      - run:
          name: Setup browserstack-ie 
          command: |
            docker build \
            --tag browserstack-ie \
            --file tests/dockerfiles/browserstack \
            .
      - run:
          name: Run unit 
          command: |
            docker run \
              --env DOCS_DIR=/code/docs/ \
              --env SPHINXBUILD=/code/test-env/bin/sphinx-build \
            unit \
      - run:
          name: Run phantomjs 
          command: |
            docker run \
              --env ARSENIC_SERVICE=PhantomJS \
              --env ARSENIC_BROWSER=PhantomJS \
            phantomjs \
      - run:
          name: Run geckodriver 
          command: |
            docker run \
              --env ARSENIC_SERVICE=Geckodriver \
              --env ARSENIC_BROWSER=Firefox \
            geckodriver \
      - run:
          name: Run browserstack-ie 
          command: |
            docker run \
              --env ARSENIC_SERVICE="Remote?url=http://${BROWSERSTACK_USERNAME}:${BROWSERSTACK_API_KEY}@hub.browserstack.com:80/wd/hub" \
              --env ARSENIC_BROWSER="InternetExplorer?version=11.0&resolution=1024x768&os_version=7&browser_version=11.0&browserstack.local=&browserstack.localIdentifier=${CIRCLE_SHA1}&os=Windows&browser=IE&project=arsenic&build=${CIRCLE_SHA1}-${CIRCLE_BUILD_NUM}-IE" \
              --env BROWSERSTACK_LOCAL_IDENTIFIER="${CIRCLE_SHA1}" \
              --env BROWSERSTACK_API_KEY="${BROWSERSTACK_API_KEY}" \
            browserstack-ie \
  setup:
    <<: *defaults
    steps:
      - setup_remote_docker:
          reusable: true
          exclusive: true
      - checkout
      - run:
          name: Build base image
          command: |
            docker build \
            --tag base:1.0 \
            --file tests/dockerfiles/base \
            .
      - run:
          name: Setup unit 
          command: |
            docker build \
            --tag unit \
            --file tests/dockerfiles/unit \
            .
      - run:
          name: Setup phantomjs 
          command: |
            docker build \
            --tag phantomjs \
            --file tests/dockerfiles/phantomjs \
            .
      - run:
          name: Setup geckodriver 
          command: |
            docker build \
            --tag geckodriver \
            --file tests/dockerfiles/geckodriver \
            .
      - run:
          name: Setup browserstack-ie 
          command: |
            docker build \
            --tag browserstack-ie \
            --file tests/dockerfiles/browserstack \
            .
  unit:
    <<: *defaults
    steps:
      - setup_remote_docker:
          reusable: true
          exclusive: true
      - checkout
      - run:
          name: Run unit 
          command: |
            docker run \
              --env DOCS_DIR=/code/docs/ \
              --env SPHINXBUILD=/code/test-env/bin/sphinx-build \
            unit \
  phantomjs:
    <<: *defaults
    steps:
      - setup_remote_docker:
          reusable: true
          exclusive: true
      - checkout
      - run:
          name: Run phantomjs 
          command: |
            docker run \
              --env ARSENIC_SERVICE=PhantomJS \
              --env ARSENIC_BROWSER=PhantomJS \
            phantomjs \
  geckodriver:
    <<: *defaults
    steps:
      - setup_remote_docker:
          reusable: true
          exclusive: true
      - checkout
      - run:
          name: Run geckodriver 
          command: |
            docker run \
              --env ARSENIC_SERVICE=Geckodriver \
              --env ARSENIC_BROWSER=Firefox \
            geckodriver \
  browserstack-ie:
    <<: *defaults
    steps:
      - setup_remote_docker:
          reusable: true
          exclusive: true
      - checkout
      - run:
          name: Run browserstack-ie 
          command: |
            docker run \
              --env ARSENIC_SERVICE="Remote?url=http://${BROWSERSTACK_USERNAME}:${BROWSERSTACK_API_KEY}@hub.browserstack.com:80/wd/hub" \
              --env ARSENIC_BROWSER="InternetExplorer?version=11.0&resolution=1024x768&os_version=7&browser_version=11.0&browserstack.local=&browserstack.localIdentifier=${CIRCLE_SHA1}&os=Windows&browser=IE&project=arsenic&build=${CIRCLE_SHA1}-${CIRCLE_BUILD_NUM}-IE" \
              --env BROWSERSTACK_LOCAL_IDENTIFIER="${CIRCLE_SHA1}" \
              --env BROWSERSTACK_API_KEY="${BROWSERSTACK_API_KEY}" \
            browserstack-ie \
workflows:
  version: 2
  build-and-deploy:
    jobs:
      - setup
      - unit:
          requires:
            - setup
      - phantomjs:
          requires:
            - setup
      - geckodriver:
          requires:
            - setup
      - browserstack-ie:
          requires:
            - setup
